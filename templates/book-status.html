{% extends "base.html" %}
{% load static %}
{% block extra_links %}

<style>
    input{display:none; width: 100%; height: 1cm; border-radius: 10px; border: 1px solid slategray;}
</style>
<script>
  function enableEdit(id) {
    let row = document.getElementById(`row-${id}`);
    let button = document.getElementById(`btn-${id}`);

    if (button.dataset.mode === "edit") {
        // Second click → submit
        row.querySelector('form').submit();
    } else {
        // First click → enable edit mode
        row.querySelectorAll('.view-mode').forEach(el => el.style.display = 'none');
        row.querySelectorAll('.edit-mode').forEach(el => el.style.display = 'block');

        button.innerText = 'Save';
        button.classList.remove('btn-success');
        button.classList.add('btn-primary');

        // Mark button as edit mode
        button.dataset.mode = "edit";
    }
}
function enableAdd() {
    let row = document.getElementById('new-row');
    let button = document.getElementById('add-btn');

    if (button.dataset.mode === "edit") {
        button.type = "submit"; // Yaha galti thi — ab ye form submit karega
    } else {
        row.querySelectorAll('.edit-mode').forEach(el => el.style.display = 'block');
        button.innerText = 'Save';
        button.classList.remove('btn-success');
        button.classList.add('btn-primary');
        button.dataset.mode = "edit";
    }
}
</script>

{% endblock %}
{% block content %}
      <main>
        {% include "usernav.html" %}
            <div class="row mt-5">
              <div class="col-sm-11 mx-auto mt-5 mb-5" id="boxes" style="box-shadow: 5px 10px 25px #000; padding: 30px; width: 90%; margin:auto; border-radius: 10px;">
                {% if messages %}
                <div id="message-container">
                    {% for message in messages %}
                    <h5 class="text-center text-danger">{{ message | safe }}</h5>
                    {% endfor %}
                </div>
                {% endif %}
                <h2 class="text-center">Book Status</h2>
                <div class="table-responsive">
                <table class="table table-striped table-bordered" style="border: black;">
                  <thead>
                    <tr class="text-center">
                      <th scope="col" style="background-color: #9DC3E6;">SR. No.</th>
                      <th scope="col" style="background-color: #9DC3E6;">Book Name</th>
                      <th scope="col" style="background-color: #9DC3E6;">Book ID</th>
                      <th scope="col" style="background-color: #9DC3E6;">Status</th>
                      <th scope="col" style="background-color: #9DC3E6;" colspan="2">Action</th>
                    </tr>
                  </thead>
                  <tbody>                           
                      {% for n in data %}
                      <tr id="row-{{ n.id }}">
                            <form method="post" action="{% url 'update_book_status' n.id %}">
                            {% csrf_token %}
                            <th scope="row" class="text-center">{{ forloop.counter }}</th>

                            <!-- book name -->
                            <td class="text-center">
                                <span class="view-mode">{{ n.book }}</span>
                                <select name="book" class="edit-mode form-control" style="display:none; width: 100%; height: 1cm; border: none;">
                                    {% for b in books %}
                                        <option value="{{ b.id }}" {% if b.id == n.book.id %}selected{% endif %}>{{ b.book_name }}</option>
                                    {% endfor %}
                                </select>
                            </td>

                            <!-- book id -->
                            <td class="text-center">
                                <span class="view-mode">{{ n.book_set_id }}</span>
                                <input type="text" placeholder="Enter publication" name="book_set_id" value="{{ n.publication }}" class="edit-mode" style="display:none; width: 100%; height: 1cm; border: none;">
                            </td>

                            <!-- status -->
                            <td>
                                <span class="view-mode">{{ n.is_available }}</span>
                                <input type="hidden" name="is_available" value="{{ n.is_available }}">
                            </td>

                            <!-- Actions -->
                            <td class="text-center">
                                <button type="button" class="btn btn-success" id="btn-{{ n.id }}" data-mode="view" onclick="enableEdit({{ n.id }})">Update</button>
                            </td>
                            <td class="text-center">
                                <a href="{% url 'delete_book_status' n.id %}" onclick="return confirm('Are you sure you want to delete this?');">
                                    <button type="button" class="btn btn-danger">Delete</button>
                                </a>
                            </td>
                            </form>
                      </tr>
                      {% endfor %}

                      <!-- Add New Row -->
                      <tr id="new-row">
                          <form method="post" action="{% url 'book_status' %}">
                          {% csrf_token %}
                          <th class="text-center">-</th>

                          <!-- book name -->
                            <td class="text-center">
                                <select name="book" class="edit-mode form-control" style="display:none; width: 100%; height: 1cm; border:none;" required>
                                    <option value="">-- Select Book --</option>
                                    {% for b in books %}
                                        <option value="{{ b.id }}">{{ b.book_name }}</option>
                                    {% endfor %}
                                </select>
                            </td>

                            <!-- book id -->
                            <td class="text-center">
                                <input type="text"  name="book_set_id" class="edit-mode" style="display:none; width: 100%; height: 1cm; border:none;" required>
                            </td>

                            <!-- status -->
                            <td class="text-center">-</td>
                            <input type="hidden" name="is_available" value="true">

                          <!-- Action -->
                          <td colspan="2" class="text-center">
                              <button type="button" id="add-btn" class="btn btn-primary" onclick="enableAdd()">Add</button>
                          </td>
                          </form>
                      </tr>
                  </tbody>
                </table>
                </div>
              </div>
            </div>
      </main>
{% endblock %}